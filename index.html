<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Cat Banana Bash</title>
    <style>
        :root {
            color-scheme: dark;
            --space-blue: #020c37;
            --nebula-violet: #684b9b;
            --laser-pink: #ff78d5;
            --banana-yellow: #fbd76f;
            --banana-shadow: #c5852f;
        }
        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: "Trebuchet MS", "Segoe UI", sans-serif;
            background:
                radial-gradient(circle at 20% 20%, rgba(104, 75, 155, 0.35), transparent 45%),
                radial-gradient(circle at 80% 30%, rgba(255, 120, 213, 0.18), transparent 60%),
                linear-gradient(160deg, #020c37 0%, #0f1954 45%, #1c2d73 100%);
            color: #fdf9ff;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            margin: 1.2rem auto 0.2rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            text-shadow: 0 0 14px rgba(255, 120, 213, 0.6);
        }

        .subtitle {
            text-align: center;
            margin: 0 auto 1.4rem;
            font-size: clamp(0.95rem, 2vw, 1.3rem);
            opacity: 0.85;
        }

        .game-area {
            position: relative;
            width: min(960px, calc(100% - 2.4rem));
            height: clamp(420px, calc(100vh - 12rem), 640px);
            margin: 0 auto;
            border-radius: 28px;
            overflow: hidden;
            background: radial-gradient(circle at 65% 20%, rgba(94, 242, 255, 0.12), transparent 60%),
                        radial-gradient(circle at 25% 80%, rgba(255, 120, 213, 0.1), transparent 70%),
                        linear-gradient(180deg, rgba(2, 12, 55, 0.95), rgba(10, 26, 82, 0.95));
            border: 1px solid rgba(94, 242, 255, 0.25);
            box-shadow: 0 0 42px rgba(2, 12, 55, 0.65);
        }

        .stars {
            position: absolute;
            inset: -200px;
            background-repeat: repeat;
            background-size: 250px 250px;
            animation: drift var(--speed) linear infinite;
            pointer-events: none;
            --speed: 95s;
            opacity: 0.45;
            background-image:
                radial-gradient(2px 2px at 20px 20px, #ffffff, transparent),
                radial-gradient(1px 1px at 60px 80px, #c5f0ff, transparent),
                radial-gradient(1px 1px at 120px 140px, #f7f0ff, transparent);
        }

        .stars.layer-2 {
            --speed: 140s;
            opacity: 0.22;
            background-image:
                radial-gradient(2px 2px at 50px 50px, #e6dcff, transparent),
                radial-gradient(1px 1px at 150px 120px, rgba(120, 255, 200, 0.8), transparent);
        }

        .nebula-swoosh {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120vw;
            height: 120vw;
            background: conic-gradient(from 90deg, rgba(255, 120, 213, 0.05), rgba(94, 242, 255, 0.18), rgba(255, 120, 213, 0.05));
            filter: blur(5px);
            opacity: 0.65;
            transform: translate(-50%, -50%);
        }

        @keyframes drift {
            from { transform: translate3d(0, 0, 0) rotate(0deg); }
            to { transform: translate3d(120px, 220px, 0) rotate(1turn); }
        }

        .hud {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1.5rem;
            align-items: center;
            padding: 0.6rem 1.8rem;
            border-radius: 999px;
            background: rgba(2, 12, 55, 0.55);
            border: 1px solid rgba(94, 242, 255, 0.4);
            backdrop-filter: blur(6px);
            z-index: 3;
            color: #dff9ff;
        }

        .hud span {
            letter-spacing: 0.06em;
        }

        .instructions {
            position: absolute;
            right: 1.2rem;
            bottom: 1.2rem;
            padding: 0.9rem 1.2rem;
            border-radius: 14px;
            background: rgba(2, 12, 55, 0.75);
            border: 1px solid rgba(255, 120, 213, 0.3);
            max-width: 260px;
            font-size: 0.9rem;
            line-height: 1.4;
            z-index: 3;
        }

        .instructions strong {
            color: #ffddff;
        }

        .ground-glow {
            position: absolute;
            bottom: -45px;
            left: 50%;
            width: 130%;
            height: 150px;
            transform: translateX(-50%);
            background: radial-gradient(circle at 50% 0%, rgba(94, 242, 255, 0.25), transparent 60%);
            pointer-events: none;
            filter: blur(20px);
        }

        .space-cat-player {
            position: absolute;
            width: clamp(140px, 15vw, 200px);
            aspect-ratio: 1;
            transform-origin: center;
            transition: transform 0.15s ease;
            filter: drop-shadow(0 0 18px rgba(0, 0, 0, 0.65));
            z-index: 2;
        }

        .space-cat-player img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 28% 28% 32% 32%;
            filter: drop-shadow(0 0 18px rgba(94, 242, 255, 0.55));
            pointer-events: none;
            user-select: none;
        }

        .banana-target {
            position: absolute;
            width: clamp(40px, 4.6vw, 60px);
            aspect-ratio: 1 / 2.4;
            background: radial-gradient(circle at 40% 35%, rgba(255, 255, 255, 0.55), transparent 65%),
                        radial-gradient(circle at 70% 20%, rgba(255, 255, 255, 0.45), transparent 60%),
                        radial-gradient(circle at 50% 65%, rgba(0, 0, 0, 0.25), transparent 70%),
                        linear-gradient(120deg, var(--banana-yellow) 0%, #fff3b4 50%, var(--banana-yellow) 100%);
            border-radius: 60% 60% 35% 35% / 55% 55% 25% 25%;
            transform-origin: center;
            box-shadow: inset -6px -18px 18px rgba(197, 133, 47, 0.25);
            will-change: transform;
        }

        .banana-target::after {
            content: "";
            position: absolute;
            bottom: -6%;
            left: 50%;
            width: 48%;
            height: 18%;
            transform: translateX(-50%);
            border-radius: 40px;
            background: radial-gradient(circle at 50% 40%, rgba(0, 0, 0, 0.35), transparent 65%);
        }

        .banana-target::before {
            content: "";
            position: absolute;
            top: -6%;
            left: 46%;
            width: 30%;
            height: 22%;
            transform: rotate(-12deg);
            background: linear-gradient(120deg, var(--banana-shadow), rgba(0, 0, 0, 0.15));
            border-radius: 20px;
        }

        .projectile {
            position: absolute;
            width: 36px;
            height: 16px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 120, 213, 0.65));
            border-radius: 999px;
            box-shadow: 0 0 18px rgba(255, 120, 213, 0.6);
            z-index: 2;
            transform-origin: center;
            pointer-events: none;
        }

        .alien {
            position: absolute;
            width: clamp(104px, 12vw, 160px);
            aspect-ratio: 1.05;
            border-radius: 48% 52% 58% 42% / 55% 45% 60% 40%;
            background:
                radial-gradient(circle at 30% 28%, rgba(255, 255, 255, 0.6) 0%, transparent 65%),
                radial-gradient(circle at 70% 34%, rgba(255, 255, 255, 0.35) 0%, transparent 60%),
                linear-gradient(160deg, var(--alien-primary, #04321a) 0%, var(--alien-secondary, #127943) 38%, var(--alien-tertiary, #2dd482) 70%, var(--alien-primary, #04321a) 100%);
            border: 3px solid var(--alien-glow, rgba(174, 255, 220, 0.6));
            box-shadow: 0 0 30px var(--alien-glow, rgba(120, 255, 200, 0.45));
            display: flex;
            align-items: center;
            justify-content: center;
            animation: alien-hover 4.2s ease-in-out infinite;
            z-index: 2;
            overflow: visible;
        }

        .alien::before,
        .alien::after {
            content: "";
            position: absolute;
            width: 28%;
            height: 32%;
            top: 32%;
            border-radius: 50%;
            background: radial-gradient(circle at 50% 42%, #ffffff 0%, var(--alien-eye, rgba(174, 255, 220, 0.8)) 55%, rgba(0, 0, 0, 0.85) 90%);
            box-shadow: 0 0 14px rgba(0, 0, 0, 0.35);
        }

        .alien::before {
            left: 18%;
        }

        .alien::after {
            right: 18%;
        }

        .alien .antenna {
            position: absolute;
            top: -28px;
            left: 50%;
            width: 6px;
            height: 32px;
            transform: translateX(-50%);
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.85), var(--alien-tertiary, rgba(120, 255, 200, 0.85)));
            box-shadow: 0 0 8px var(--alien-glow, rgba(174, 255, 220, 0.6));
        }

        .alien .antenna::after {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            width: 18px;
            height: 18px;
            transform: translateX(-50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, var(--alien-glow, rgba(120, 255, 200, 0.9)) 48%, rgba(0, 0, 0, 0) 75%);
            box-shadow: 0 0 12px var(--alien-glow, rgba(174, 255, 220, 0.9));
        }

        .alien span {
            position: absolute;
            bottom: -14px;
            width: 70%;
            height: 20px;
            background: linear-gradient(90deg, var(--alien-glow, rgba(120, 255, 200, 0.65)), rgba(0, 180, 120, 0));
            border-radius: 999px;
            filter: blur(5px);
            animation: alien-thruster 0.38s ease-in-out infinite alternate;
            opacity: 0.7;
        }

        .alien .mouth {
            position: absolute;
            bottom: 30%;
            width: 32%;
            height: 16%;
            border-radius: 60% 60% 80% 80%;
            background: radial-gradient(circle at 50% 35%, rgba(255, 255, 255, 0.45) 0%, rgba(0, 0, 0, 0.35) 55%, transparent 80%);
            border: 2px solid rgba(0, 0, 0, 0.35);
            box-shadow: inset 0 -4px 6px rgba(0, 0, 0, 0.4);
        }

        @keyframes alien-hover {
            0%, 100% { transform: translateY(-8px) rotate(-2deg); }
            50% { transform: translateY(8px) rotate(2deg); }
        }

        @keyframes alien-thruster {
            from { opacity: 0.6; height: 16px; }
            to { opacity: 0.9; height: 26px; }
        }

        .message-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            background: rgba(1, 5, 27, 0.75);
            backdrop-filter: blur(6px);
            color: #fff4ff;
            z-index: 5;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .message-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .message-overlay button {
            padding: 0.6rem 1.4rem;
            border-radius: 999px;
            border: 2px solid rgba(255, 120, 213, 0.6);
            background: rgba(94, 242, 255, 0.18);
            color: #fff;
            font-size: 1rem;
            letter-spacing: 0.05em;
            cursor: pointer;
        }

        .message-overlay button:hover {
            background: rgba(255, 120, 213, 0.3);
        }

        @media (max-width: 720px) {
            .hud {
                top: auto;
                bottom: 1rem;
                width: calc(100% - 2.5rem);
                justify-content: space-between;
            }

            .instructions {
                left: 50%;
                bottom: auto;
                top: 5.6rem;
                transform: translateX(-50%);
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <h1>Space Cat Banana Bash</h1>
    <p class="subtitle">Pilot your slightly realistic space kitty saucer through the cosmic chaos.</p>

    <div class="game-area" aria-label="Playable space cat avoiding aliens and blasting bananas">
        <div class="stars layer-1" aria-hidden="true"></div>
        <div class="stars layer-2" aria-hidden="true"></div>
        <div class="nebula-swoosh" aria-hidden="true"></div>
        <div class="ground-glow" aria-hidden="true"></div>
        <div class="hud" role="status" aria-live="polite">
            <span id="score">Score: 0</span>
            <span id="lives">Lives: 3</span>
        </div>

        <div class="instructions">
            <strong>Controls</strong><br>
            Move: A / D or ← / →<br>
            Double jump: tap W / ↑ again midair<br>
            Shoot: Click anywhere or Spacebar<br>
            Nab bananas for points and avoid colliding with aliens!
        </div>

        <div id="cat" class="space-cat-player" role="img" aria-label="Slightly realistic space cat hero"></div>

        <div id="message" class="message-overlay" role="alertdialog" aria-modal="true" aria-hidden="true">
            <h2 id="message-title">Game Over</h2>
            <p id="message-detail">Those aliens got your whiskers.</p>
            <button type="button" id="restart">Play Again</button>
        </div>
    </div>

    <script>
        const gameArea = document.querySelector('.game-area');
        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const catEl = document.getElementById('cat');
        const messageOverlay = document.getElementById('message');
        const messageTitle = document.getElementById('message-title');
        const messageDetail = document.getElementById('message-detail');
        const restartBtn = document.getElementById('restart');

        // Drop in the custom Paint 3D cat so the player matches the concept art.
        catEl.innerHTML = `
            <img src="img/space cat png.png" alt="Space cat pilot" class="cat-portrait" loading="lazy" decoding="async" draggable="false">
        `;

        const keys = {
            left: false,
            right: false,
        };

        const state = {
            score: 0,
            lives: 3,
            catX: 50,
            catY: 65,
            catVX: 0,
            catVY: 0,
            facing: 1,
            onGround: false,
            jumpCount: 0,
            shootCooldown: 0,
            gameOver: false,
        };

    const bananas = new Set();
    const aliens = new Set();
    const projectiles = new Set();

        const config = {
            gravity: 210,
            moveSpeed: 190,
            jumpStrength: 360,
            maxJumps: 2,
            doubleJumpDecay: 0.82,
            shootDelay: 260,
            projectileSpeed: 420,
            projectileLifetime: 1800,
            bananaPoints: 150,
            alienPoints: 400,
            alienSpawnChance: 0.002,
            alienSpeedRange: [32, 52],
            alienAmplitudeRange: [16, 36],
            alienFrequencyRange: [0.4, 1.0],
        };

        const alienPalettes = [
            {
                primary: '#04321a',
                secondary: '#127943',
                tertiary: '#2dd482',
                glow: 'rgba(126, 255, 214, 0.55)',
                eye: 'rgba(174, 255, 220, 0.9)',
            },
            {
                primary: '#2b0454',
                secondary: '#5f24a6',
                tertiary: '#b276ff',
                glow: 'rgba(192, 150, 255, 0.55)',
                eye: 'rgba(220, 210, 255, 0.9)',
            },
            {
                primary: '#3b1030',
                secondary: '#862d6c',
                tertiary: '#ff7ac3',
                glow: 'rgba(255, 144, 218, 0.55)',
                eye: 'rgba(255, 220, 240, 0.9)',
            },
            {
                primary: '#05243f',
                secondary: '#0f4d73',
                tertiary: '#5fd9ff',
                glow: 'rgba(125, 220, 255, 0.55)',
                eye: 'rgba(204, 240, 255, 0.9)',
            },
        ];

        const randomBetween = (min, max) => Math.random() * (max - min) + min;

        let musicStarted = false;
        let audioCtx = null;
        let melodyInterval = null;
        let melodyOsc = null;
        let bassOsc = null;
        let melodyGain = null;
        let bassGain = null;

        function startMusic() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) {
                return;
            }

            if (musicStarted) {
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                return;
            }

            audioCtx = new AudioContext();
            melodyGain = audioCtx.createGain();
            melodyGain.gain.value = 0.06;
            melodyGain.connect(audioCtx.destination);

            melodyOsc = audioCtx.createOscillator();
            melodyOsc.type = 'triangle';
            melodyOsc.connect(melodyGain);
            melodyOsc.start();

            bassGain = audioCtx.createGain();
            bassGain.gain.value = 0.04;
            bassGain.connect(audioCtx.destination);

            bassOsc = audioCtx.createOscillator();
            bassOsc.type = 'square';
            bassOsc.connect(bassGain);
            bassOsc.start();

            const melodyPattern = [784, 880, 988, 880, 784, 659, 698, 784, 880, 988, 1046, 988, 880, 784, 698, 659];
            const bassPattern = [196, 220, 196, 147, 165, 147, 196, 147, 196, 220, 247, 220, 196, 147, 131, 147];
            let step = 0;

            melodyInterval = setInterval(() => {
                if (!audioCtx) {
                    return;
                }
                const time = audioCtx.currentTime;
                const melodyNote = melodyPattern[step % melodyPattern.length];
                const bassNote = bassPattern[step % bassPattern.length];

                melodyOsc.frequency.setValueAtTime(melodyNote, time);
                bassOsc.frequency.setValueAtTime(bassNote, time);

                melodyGain.gain.cancelScheduledValues(time);
                melodyGain.gain.setValueAtTime(0.03, time);
                melodyGain.gain.linearRampToValueAtTime(0.1, time + 0.08);
                melodyGain.gain.linearRampToValueAtTime(0.05, time + 0.24);

                bassGain.gain.cancelScheduledValues(time);
                bassGain.gain.setValueAtTime(0.02, time);
                bassGain.gain.linearRampToValueAtTime(0.06, time + 0.12);
                bassGain.gain.linearRampToValueAtTime(0.03, time + 0.28);

                step = (step + 1) % (melodyPattern.length * 2);
            }, 210);

            musicStarted = true;
        }

        const bounds = () => gameArea.getBoundingClientRect();

        function updateHUD() {
            scoreEl.textContent = `Score: ${state.score}`;
            livesEl.textContent = `Lives: ${state.lives}`;
        }

        function spawnBanana() {
            const banana = document.createElement('div');
            banana.className = 'banana-target';
            gameArea.appendChild(banana);
            const rawVX = Math.random() * 120 - 60;
            const rawVY = Math.random() * 90 - 45;
            const vx = Math.abs(rawVX) < 25 ? 25 * Math.sign(rawVX || 1) : rawVX;
            const vy = Math.abs(rawVY) < 18 ? 18 * Math.sign(rawVY || 1) : rawVY;
            const entity = {
                el: banana,
                x: Math.random() * (bounds().width - 60) + 20,
                y: Math.random() * (bounds().height * 0.5) + 60,
                vx,
                vy,
                rotation: Math.random() * 360,
                spin: Math.random() * 120 - 60,
            };
            banana.style.transform = `translate(${entity.x}px, ${entity.y}px) rotate(${entity.rotation}deg)`;
            bananas.add(entity);
        }

        function spawnAlien() {
            const alien = document.createElement('div');
            alien.className = 'alien';
            alien.setAttribute('role', 'img');
            alien.setAttribute('aria-label', 'Glowing alien rival');
            const antenna = document.createElement('div');
            antenna.className = 'antenna';
            antenna.setAttribute('aria-hidden', 'true');
            const mouth = document.createElement('div');
            mouth.className = 'mouth';
            mouth.setAttribute('aria-hidden', 'true');
            const thruster = document.createElement('span');
            thruster.setAttribute('aria-hidden', 'true');
            alien.appendChild(antenna);
            alien.appendChild(mouth);
            alien.appendChild(thruster);
            gameArea.appendChild(alien);
            const direction = Math.random() > 0.5 ? 1 : -1;
            const area = bounds();
            const baseY = randomBetween(60, Math.max(140, area.height * 0.45));
            const palette = alienPalettes[Math.floor(Math.random() * alienPalettes.length)];
            alien.style.setProperty('--alien-primary', palette.primary);
            alien.style.setProperty('--alien-secondary', palette.secondary);
            alien.style.setProperty('--alien-tertiary', palette.tertiary);
            alien.style.setProperty('--alien-glow', palette.glow);
            alien.style.setProperty('--alien-eye', palette.eye);
            const entity = {
                el: alien,
                x: Math.random() * (area.width - 140) + 20,
                y: baseY,
                baseY,
                vx: randomBetween(config.alienSpeedRange[0], config.alienSpeedRange[1]) * direction,
                amplitude: randomBetween(config.alienAmplitudeRange[0], config.alienAmplitudeRange[1]),
                frequency: randomBetween(config.alienFrequencyRange[0], config.alienFrequencyRange[1]),
                phase: Math.random() * Math.PI * 2,
            };
            alien.style.transform = `translate(${entity.x}px, ${entity.y}px)`;
            aliens.add(entity);
        }

        function shootBananaProjectile(targetX, targetY) {
            if (state.shootCooldown > 0 || state.gameOver) {
                return;
            }
            state.shootCooldown = config.shootDelay;
            const projectile = document.createElement('div');
            projectile.className = 'projectile';
            gameArea.appendChild(projectile);

            const originX = state.catX + catEl.offsetWidth * 0.5;
            const originY = state.catY + catEl.offsetHeight * 0.45;
            let vx;
            let vy;

            if (typeof targetX === 'number' && typeof targetY === 'number') {
                const dx = targetX - originX;
                const dy = targetY - originY;
                const length = Math.hypot(dx, dy) || 1;
                vx = (dx / length) * config.projectileSpeed;
                vy = (dy / length) * config.projectileSpeed;
                state.facing = dx >= 0 ? 1 : -1;
            } else {
                vx = config.projectileSpeed * state.facing;
                vy = 0;
            }

            const data = {
                el: projectile,
                x: originX,
                y: originY,
                vx,
                vy,
                lifetime: config.projectileLifetime,
                angle: Math.atan2(vy, vx),
            };

            projectile.style.transform = `translate(${data.x}px, ${data.y}px) rotate(${data.angle}rad)`;
            projectiles.add(data);
        }

        function removeEntity(set, entity) {
            if (set.has(entity)) {
                entity.el.remove();
                set.delete(entity);
            }
        }

        function resetGame() {
            projectiles.forEach(p => p.el.remove());
            bananas.forEach(b => b.el.remove());
            aliens.forEach(a => a.el.remove());
            projectiles.clear();
            bananas.clear();
            aliens.clear();

            state.score = 0;
            state.lives = 3;
            state.catX = bounds().width / 2 - catEl.offsetWidth / 2;
            state.catY = bounds().height - catEl.offsetHeight - 40;
            state.catVX = 0;
            state.catVY = 0;
            state.facing = 1;
            state.onGround = true;
            state.jumpCount = 0;
            state.gameOver = false;
            state.shootCooldown = 0;

            catEl.style.transform = `translate(${state.catX}px, ${state.catY}px) scaleX(${state.facing})`;

            updateHUD();
            messageOverlay.classList.remove('active');
            messageOverlay.setAttribute('aria-hidden', 'true');

            for (let i = 0; i < 6; i++) {
                spawnBanana();
            }

            for (let i = 0; i < 2; i++) {
                spawnAlien();
            }
        }

        function endGame(text, detail) {
            state.gameOver = true;
            messageTitle.textContent = text;
            messageDetail.textContent = detail;
            messageOverlay.classList.add('active');
            messageOverlay.setAttribute('aria-hidden', 'false');
        }

        function handleInput() {
            state.catVX = 0;
            if (keys.left) {
                state.catVX -= config.moveSpeed;
                state.facing = -1;
            }
            if (keys.right) {
                state.catVX += config.moveSpeed;
                state.facing = 1;
            }
        }

        function attemptJump() {
            if (state.gameOver) {
                return;
            }
            if (state.onGround) {
                state.jumpCount = 0;
            }
            if (state.jumpCount >= config.maxJumps) {
                return;
            }
            const isFirstJump = state.jumpCount === 0;
            const strength = isFirstJump ? config.jumpStrength : config.jumpStrength * config.doubleJumpDecay;
            state.catVY = -strength;
            state.onGround = false;
            state.jumpCount += 1;
        }

        function clampCat() {
            const area = bounds();
            const width = catEl.offsetWidth;
            const height = catEl.offsetHeight;

            state.catX = Math.max(10, Math.min(area.width - width - 10, state.catX));
            const floorY = area.height - height - 30;
            if (state.catY >= floorY) {
                if (!state.onGround) {
                    state.jumpCount = 0;
                }
                state.catY = floorY;
                state.catVY = 0;
                state.onGround = true;
            } else if (state.catY < 10) {
                state.catY = 10;
                state.catVY = 0;
            } else {
                state.onGround = false;
            }
        }

        function updateEntities(dt) {
            const area = bounds();

            bananas.forEach(banana => {
                banana.x += banana.vx * dt;
                banana.y += banana.vy * dt;
                banana.rotation += banana.spin * dt;

                const width = banana.el.offsetWidth || 50;
                const height = banana.el.offsetHeight || 90;
                const padX = 20;
                const minY = 40;
                const maxY = Math.max(minY + 40, area.height - height - 80);

                if (banana.x <= padX) {
                    banana.x = padX;
                    banana.vx *= -1;
                } else if (banana.x >= area.width - width - padX) {
                    banana.x = area.width - width - padX;
                    banana.vx *= -1;
                }

                if (banana.y <= minY) {
                    banana.y = minY;
                    banana.vy *= -1;
                } else if (banana.y >= maxY) {
                    banana.y = maxY;
                    banana.vy *= -1;
                }

                banana.el.style.transform = `translate(${banana.x}px, ${banana.y}px) rotate(${banana.rotation}deg)`;
            });

            projectiles.forEach(projectile => {
                projectile.x += projectile.vx * dt;
                projectile.y += projectile.vy * dt;
                projectile.lifetime -= dt * 1000;
                const outOfBounds = (
                    projectile.x < -120 ||
                    projectile.x > area.width + 120 ||
                    projectile.y < -120 ||
                    projectile.y > area.height + 120
                );
                if (projectile.lifetime <= 0 || outOfBounds) {
                    removeEntity(projectiles, projectile);
                    return;
                }
                projectile.el.style.transform = `translate(${projectile.x}px, ${projectile.y}px) rotate(${projectile.angle}rad)`;
            });

            aliens.forEach(alien => {
                alien.x += alien.vx * dt;
                if (alien.x <= 10 || alien.x >= area.width - alien.el.offsetWidth - 10) {
                    alien.vx *= -1;
                    alien.x = Math.max(10, Math.min(area.width - alien.el.offsetWidth - 10, alien.x));
                }
                alien.phase += alien.frequency * dt;
                alien.y = alien.baseY + Math.sin(alien.phase) * alien.amplitude;
                alien.el.style.transform = `translate(${alien.x}px, ${alien.y}px)`;
            });
        }

        function checkCollisions() {
            const catRect = catEl.getBoundingClientRect();

            const aliensArray = Array.from(aliens);
            const bananasArray = Array.from(bananas);
            const projectilesArray = Array.from(projectiles);

            aliensArray.forEach(alien => {
                if (!aliens.has(alien)) {
                    return;
                }
                const alienRect = alien.el.getBoundingClientRect();
                if (rectsOverlap(catRect, alienRect)) {
                    aliens.delete(alien);
                    alien.el.remove();
                    state.lives -= 1;
                    if (state.lives < 0) {
                        state.lives = 0;
                    }
                    updateHUD();
                    if (state.lives <= 0) {
                        endGame('Game Over', 'Those aliens got your whiskers.');
                    }
                }
            });

            projectilesArray.forEach(projectile => {
                if (!projectiles.has(projectile)) {
                    return;
                }
                const projRect = projectile.el.getBoundingClientRect();

                bananasArray.forEach(banana => {
                    if (!bananas.has(banana)) {
                        return;
                    }
                    const bananaRect = banana.el.getBoundingClientRect();
                    if (rectsOverlap(projRect, bananaRect)) {
                        state.score += config.bananaPoints;
                        updateHUD();
                        removeEntity(projectiles, projectile);
                        banana.el.remove();
                        bananas.delete(banana);
                        spawnBanana();
                    }
                });

                aliensArray.forEach(alien => {
                    if (!aliens.has(alien) || !projectiles.has(projectile)) {
                        return;
                    }
                    const alienRect = alien.el.getBoundingClientRect();
                    if (rectsOverlap(projRect, alienRect)) {
                        state.score += config.alienPoints;
                        updateHUD();
                        removeEntity(projectiles, projectile);
                        aliens.delete(alien);
                        alien.el.remove();
                    }
                });
            });
        }

        function rectsOverlap(a, b) {
            return !(
                a.right < b.left ||
                a.left > b.right ||
                a.bottom < b.top ||
                a.top > b.bottom
            );
        }

        let lastTime = performance.now();

        function gameLoop(now) {
            const dt = Math.min((now - lastTime) / 1000, 0.04);
            lastTime = now;

            if (!state.gameOver) {
                handleInput();

                state.catX += state.catVX * dt;
                state.catVY += config.gravity * dt;
                state.catY += state.catVY * dt;

                clampCat();

                if (state.shootCooldown > 0) {
                    state.shootCooldown = Math.max(0, state.shootCooldown - dt * 1000);
                }

                catEl.style.transform = `translate(${state.catX}px, ${state.catY}px) scaleX(${state.facing})`;
                updateEntities(dt);
                checkCollisions();

                const spawnRoll = config.alienSpawnChance * dt * 60;
                if (Math.random() < spawnRoll && aliens.size < 6) {
                    spawnAlien();
                }
            }

            requestAnimationFrame(gameLoop);
        }

        gameArea.addEventListener('pointerdown', event => {
            if (state.gameOver) {
                return;
            }
            if (event.target.closest('.hud, .instructions, .message-overlay')) {
                return;
            }
            event.preventDefault();
            startMusic();
            const rect = bounds();
            const targetX = event.clientX - rect.left;
            const targetY = event.clientY - rect.top;
            shootBananaProjectile(targetX, targetY);
        });

        document.addEventListener('keydown', event => {
            startMusic();
            switch (event.code) {
                case 'ArrowLeft':
                case 'KeyA':
                    keys.left = true;
                    break;
                case 'ArrowRight':
                case 'KeyD':
                    keys.right = true;
                    break;
                case 'ArrowUp':
                case 'KeyW':
                    if (event.repeat) {
                        break;
                    }
                    event.preventDefault();
                    attemptJump();
                    break;
                case 'Space':
                    event.preventDefault();
                    shootBananaProjectile();
                    break;
                default:
                    break;
            }
        });

        document.addEventListener('keyup', event => {
            switch (event.code) {
                case 'ArrowLeft':
                case 'KeyA':
                    keys.left = false;
                    break;
                case 'ArrowRight':
                case 'KeyD':
                    keys.right = false;
                    break;
                default:
                    break;
            }
        });

        restartBtn.addEventListener('click', () => {
            resetGame();
            startMusic();
        });

        window.addEventListener('resize', () => {
            if (!state.gameOver) {
                state.catX = Math.min(state.catX, bounds().width - catEl.offsetWidth - 20);
                state.catY = Math.min(state.catY, bounds().height - catEl.offsetHeight - 30);
            }
        });

        resetGame();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
